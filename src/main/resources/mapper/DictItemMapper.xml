<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.jjxy.researchmanagementsystem.mapper.DictItemMapper">

    <select id="page" resultType="edu.jjxy.researchmanagementsystem.entity.DictItem">
        SELECT
        id,
        type_code AS typeCode,
        item_code AS itemCode,
        item_name AS itemName,
        status,
        sort_no AS sortNo,
        remark,
        created_at AS createdAt,
        updated_at AS updatedAt
        FROM sys_dict_item
        <where>
            <if test="typeCode != null and typeCode != ''">
                AND type_code = #{typeCode}
            </if>
            <if test="itemCode != null and itemCode != ''">
                AND item_code LIKE CONCAT('%', #{itemCode}, '%')
            </if>
            <if test="itemName != null and itemName != ''">
                AND item_name LIKE CONCAT('%', #{itemName}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY sort_no ASC, id ASC
    </select>

    <!-- 业务页面读取：仅启用项 -->
    <select id="listEnabledByTypeCode" resultType="edu.jjxy.researchmanagementsystem.entity.DictItem">
        SELECT
            id,
            type_code AS typeCode,
            item_code AS itemCode,
            item_name AS itemName,
            status,
            sort_no AS sortNo,
            remark,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM sys_dict_item
        WHERE type_code = #{typeCode}
          AND status = 1
        ORDER BY sort_no ASC, id ASC
    </select>

    <select id="maxSortNoByTypeCode" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(sort_no), 0)
        FROM sys_dict_item
        WHERE type_code = #{typeCode}
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_dict_item(type_code, item_code, item_name, status, sort_no, remark, created_at, updated_at)
        VALUES(#{typeCode}, #{itemCode}, #{itemName}, #{status}, #{sortNo}, #{remark}, NOW(), NOW())
    </insert>

    <update id="update">
        UPDATE sys_dict_item
        SET type_code = #{typeCode},
            item_code = #{itemCode},
            item_name = #{itemName},
            status = #{status},
            sort_no = #{sortNo},
            remark = #{remark},
            updated_at = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM sys_dict_item WHERE id = #{id}
    </delete>

    <delete id="deleteByTypeCode">
        DELETE FROM sys_dict_item WHERE type_code = #{typeCode}
    </delete>

</mapper>
